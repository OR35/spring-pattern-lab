# [Refactoring] Google OAuth 2.0: ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì»¤ìŠ¤í…€ íŒì—… ë°©ì‹ìœ¼ë¡œì˜ ì „í™˜

êµ¬ê¸€ ë¡œê·¸ì¸ì„ êµ¬í˜„í•˜ë©° ì‚¬ìš©í•œ ë‘ ê°€ì§€ ë°©ì‹(Custom Popup + postMessage / vue3-google-login ë¼ì´ë¸ŒëŸ¬ë¦¬)ì˜ ì°¨ì´ì ê³¼ ë³´ì•ˆì  ê³ ë ¤ì‚¬í•­ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

ë””ìì¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•(ë‹¤í¬ëª¨ë“œ ëŒ€ì‘) ë° Form ì œì–´ì˜ ìœ ì—°ì„±ì„ í™•ë³´í•˜ê¸° ìœ„í•´ ê¸°ì¡´ ë¼ì´ë¸ŒëŸ¬ë¦¬(`vue3-google-login`)ë¥¼ ê±·ì–´ë‚´ê³  ì§ì ‘ OAuth íë¦„ì„ êµ¬í˜„í•œ ê¸°ë¡ì…ë‹ˆë‹¤.

---

## 1. êµ¬í˜„ ë°©ì‹ ë¹„êµ

| êµ¬ë¶„ | ë°©ì‹ 1: Custom Popup (`postMessage`) | ë°©ì‹ 2: `vue3-google-login` ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| :--- | :--- | :--- |
| **íë¦„** | ë°±ì—”ë“œ Redirect â†’ Callback í˜ì´ì§€ì—ì„œ JSë¡œ ë°ì´í„° ì „ì†¡ | í”„ë¡ íŠ¸ì—ì„œ ì§ì ‘ Google ì¸ì¦ â†’ `idToken` ë°±ì—”ë“œ ì „ì†¡ |
| **ì¥ì ** | ë°±ì—”ë“œì—ì„œ ì¸ì¦ ë¡œì§ì„ ì „ë‹´í•˜ì—¬ ë³´ì•ˆ ì œì–´ ìš©ì´ | í”„ë¡ íŠ¸ êµ¬í˜„ì´ ë§¤ìš° ê°„í¸í•˜ê³  UXê°€ ë§¤ë„ëŸ¬ì›€ |
| **íŠ¹ì§•** | `window.open`ê³¼ `window.opener.postMessage` í™œìš© | JWT ë””ì½”ë”©ì„ í†µí•œ í”„ë¡ íŠ¸ ì •ë³´ ì„ í™•ì¸ ê°€ëŠ¥ |

---

## 2. ë¬¸ì œ ìƒí™© (As-Is)
ê¸°ì¡´ì—ëŠ” `vue3-google-login` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê³  ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### ğŸ§ ë°œìƒí•œ í•œê³„ì 
* **ë””ìì¸ ì»¤ìŠ¤í„°ë§ˆì´ì§• ì œì•½:** ì„œë¹„ìŠ¤ì˜ ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ë””ìì¸ ê°€ì´ë“œì— ë§ì¶˜ ì»¤ìŠ¤í…€ ë²„íŠ¼ êµ¬í˜„ì´ ê¹Œë‹¤ë¡œì›€.
* **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì œì–´:** ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¶”ê°€ì ì¸ Form ë°ì´í„° ì²˜ë¦¬ë‚˜ ë¦¬ë‹¤ì´ë ‰ì…˜ ë¡œì§ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ ì‚¬ì´í´ì— ë§ì¶”ì–´ì•¼ í•˜ëŠ” ì œì•½ ë°œìƒ.

---

## 3. í•´ê²° ê³¼ì • ë° ê°œì„  (To-Be)
ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê±°í•˜ê³ , **`window.open` (íŒì—…)**ê³¼ **`postMessage` API**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ êµ¬ê¸€ OAuth 2.0 íë¦„ì„ ì œì–´í•˜ë„ë¡ ë¦¬íŒ©í† ë§í–ˆìŠµë‹ˆë‹¤.


### ê°œì„  í¬ì¸íŠ¸
1. **ì»¤ìŠ¤í…€ UI êµ¬í˜„:** ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œì— ë”°ë¼ ì•„ì´ì½˜ê³¼ ìŠ¤íƒ€ì¼ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í•˜ëŠ” ì»¤ìŠ¤í…€ ë²„íŠ¼(`google-btn`)ì„ ì™„ì „í•˜ê²Œ ì œì–´.
2. **íŒì—… í†µì‹  ê·œê²©í™”:** ë°±ì—”ë“œ ì½œë°± í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ì„ ì²˜ë¦¬í•œ í›„, ê²°ê³¼ë¥¼ ë¶€ëª¨ ì°½ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” `postMessage` ë³´ì•ˆ í†µì‹  êµ¬ì¶•.
3. **ì¤‘ì•™ ì§‘ì¤‘ì‹ ìƒíƒœ ê´€ë¦¬:** ë¡œê·¸ì¸ ê²°ê³¼ë¥¼ ìˆ˜ì‹ í•˜ìë§ˆì `auth.setAuth(user)`ë¥¼ í†µí•´ ì „ì—­ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë™ì  ë¦¬ë‹¤ì´ë ‰ì…˜ ìˆ˜í–‰.

```javascript
const googleLogin = () => {
  // 1. í™”ë©´ ì¤‘ì•™ì— íŒì—… ìœ„ì¹˜ ê³„ì‚° ë° ì˜¤í”ˆ
  const popup = window.open(redirectUrl, 'google-oauth', `width=${width},height=${height},top=${top},left=${left}`);

  // 2. ë°±ì—”ë“œ(íŒì—…)ë¡œë¶€í„° ì¸ì¦ ê²°ê³¼ ìˆ˜ì‹  ëŒ€ê¸°
  window.addEventListener('message', (event) => {
    if (event.origin !== backendServerUrl) return; // ë³´ì•ˆ: ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì„œë²„ë§Œ ìˆ˜ë½
    
    const { user } = event.data;
    auth.setAuth(user); // ì „ì—­ ìƒíƒœ ì €ì¥
    router.push(route.query.redirectTo || '/');
  }, { once: true }); // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìë™ ì œê±°
};
```
---

## 4. ì„±ê³¼ ë° íšŒê³ 

1. ììœ¨ì„± í™•ë³´: ë” ì´ìƒ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì—…ë°ì´íŠ¸ë‚˜ ì œì•½ ì‚¬í•­ì— ì–½ë§¤ì´ì§€ ì•Šê³  ì„œë¹„ìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” ë¡œê·¸ì¸ì„ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ ë¨.
2. ë³´ì•ˆ ê°•í™”: postMessage ìˆ˜ì‹  ì‹œ origin ê²€ì¦ ë¡œì§ì„ ì§ì ‘ êµ¬í˜„í•¨ìœ¼ë¡œì¨ í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…(XSS) ìœ„í˜‘ì— ëŒ€ì‘í•¨.

---

> **ì—°ê´€ íŒ¨í„´:** [ì»¤ìŠ¤í…€ íŒì—… ê¸°ë°˜ì˜ ì†Œì…œ ë¡œê·¸ì¸ ì—°ë™ íŒ¨í„´](../../pattenrs/auth/google-oauth-flow.md)